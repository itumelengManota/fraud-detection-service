spring:
  application:
    name: fraud-detection-service
  threads:
    virtual:
      enabled: true

  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    properties:
      max.poll.interval.ms: 300000
      isolation.level: read_committed
      connections.max.idle.ms: 540000
      request.timeout.ms: 30000
      session.timeout.ms: 45000
    consumer:
      group-id: fraud-detection-service
      enable-auto-commit: false
      auto-offset-reset: earliest
      max-poll-records: 1000
      fetch-min-size: 1
      fetch-max-wait: 500ms
      heartbeat-interval: 3000
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: io.apicurio.registry.serde.avro.AvroKafkaDeserializer
      properties:
        # Apicurio Registry Configuration
        apicurio.registry.url: ${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v2}
        apicurio.registry.auto-register: true
        apicurio.registry.find-latest: true
        apicurio.registry.use-specific-avro-reader: true
        specific.avro.reader: true
        apicurio.registry.check-period-ms: 30000

    producer:
      acks: all
      retries: 3
      compression-type: snappy
      batch-size: 16384
      buffer-memory: 33554432
      linger: 10
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: io.apicurio.registry.serde.avro.AvroKafkaSerializer
      properties:
        # Apicurio Registry Configuration
        apicurio.registry.url: ${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v2}
        apicurio.registry.auto-register: true
        enable.idempotence: true
        max.in.flight.requests.per.connection: 5

    listener:
      ack-mode: manual
      concurrency: 10
      type: batch  # or 'single' for single-record processing
      poll-timeout: 3000
      missing-topics-fatal: false
      immediate-stop: false

    # Admin Configuration (for topic management)
    admin:
      fail-fast: false

    # Streams Configuration (if using Kafka Streams)
    streams:
      application-id: ${spring.application.name}
      properties:
        default.key.serde: org.apache.kafka.common.serialization.Serdes$StringSerde
        default.value.serde: io.confluent.kafka.streams.serdes.avro.SpecificAvroSerde
        commit.interval.ms: 1000
        num.stream.threads: 4


  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:fraud_detection}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: ${REDIS_TIMEOUT:3000ms}
      connect-timeout: ${REDIS_CONNECT_TIMEOUT:3000ms}

      enable-transaction-support: ${REDIS_ENABLE_TRANSACTIONS:true}

      # Lettuce configuration (default client)
      lettuce:
        pool:
          enabled: true
          max-active: ${REDIS_POOL_MAX_ACTIVE:50}
          max-idle: ${REDIS_POOL_MAX_IDLE:20}
          min-idle: ${REDIS_POOL_MIN_IDLE:5}
          max-wait: ${REDIS_POOL_MAX_WAIT:3000ms}
          time-between-eviction-runs: 30s

        shutdown-timeout: 100ms

    jdbc:
      repositories:
        enabled: true

  cache:
    type: redis
    redis:
      time-to-live: ${REDIS_CACHE_TTL:172800000}  # 48 hrs (in milliseconds)
      cache-null-values: false
      use-key-prefix: true
      key-prefix: ${REDIS_CACHE_KEY_PREFIX:fraud-detection:}

  flyway:
    enabled: true
    baseline-on-migrate: true

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${JWT_ISSUER_URI:http://localhost:8180/realms/fraud-detection}
          jwk-set-uri: ${JWT_JWK_SET_URI:http://localhost:8180/realms/fraud-detection/protocol/openid-connect/certs}
          audiences:
            - fraud-detection-service
            - fraud-detection-web
            - account
  docker:
    compose:
      file: ${DOCKER_COMPOSE_FILE:docker-compose/compose.yml}
  web:
    locale: af_ZA
    locale-resolver: fixed

apicurio:
  registry:
    url: ${APICURIO_REGISTRY_URL:http://localhost:8081/apis/registry/v2}

kafka:
  topics:
    transactions:
      name: transactions.normalized
      concurrency: 10
      group-id: ${spring.kafka.consumer.group-id}
    fraud-alerts-critical: fraud.alerts.critical
    fraud-alerts-high: fraud.alerts.high
    fraud-alerts-medium: fraud.alerts.medium
    domain-events: fraud-detection.domain-events

# Account Service Integration
account-service:
  base-url: ${ACCOUNT_SERVICE_URL:http://localhost:3000}

fraud-detection:
#  transaction-event-consumer:
#    idempotency:
#      ttl-minutes: 10m

  scoring:
    ml-weight: 0.6
    rule-weight: 0.4

  thresholds:
    critical: 90
    high: 70
    medium: 40

aws:
  region: us-east-1
  sagemaker:
    endpoint-name: fraud-detection-endpoint
    model-version: 1.0.0-local
    api-call-timeout: 5s
    api-call-attempt-timeout: 3s
    endpoint-url: http://localhost:8080  # Custom endpoint URL (optional)
    scaling:
      min-raw-probability: 0.00001
      max-raw-probability: 0.01

resilience4j:
  circuitbreaker:
    instances:
      sagemakerML:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        permitted-number-of-calls-in-half-open-state: 5
        wait-duration-in-open-state: 60s
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 100ms
        automatic-transition-from-open-to-half-open-enabled: true
      accountService:
        register-health-indicator: true
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        permitted-number-of-calls-in-half-open-state: 5
        wait-duration-in-open-state: 30s
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s
        automatic-transition-from-open-to-half-open-enabled: true

  retry:
    instances:
      sagemakerML:
        max-attempts: 2
        wait-duration: 50ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - software.amazon.awssdk.services.sagemakerruntime.model.ModelNotReadyException
          - software.amazon.awssdk.core.exception.SdkClientException
      accountService:
        max-attempts: 3
        wait-duration: 100ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - org.springframework.web.client.ResourceAccessException
          - java.net.ConnectException

  timelimiter:
    instances:
      sagemakerML:
        timeout-duration: 500ms
      accountService:
        timeout-duration: 3s

  bulkhead:
    instances:
      sagemakerML:
        max-concurrent-calls: 50
        max-wait-duration: 25ms
      accountService:
        max-concurrent-calls: 25
        max-wait-duration: 50ms

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
  health:
    liveness state:
      enabled: true
    readiness state:
      enabled: true

  tracing:
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:1.0}  # 100% sampling for development
  otlp:
    metrics:
      export:
        url: ${OTLP_METRICS_ENDPOINT:http://localhost:4318/v1/metrics}
  opentelemetry:
    tracing:
      export:
        otlp:
          endpoint: ${OTLP_TRACING_ENDPOINT:http://localhost:4318/v1/traces}
    logging:
      export:
        otlp:
          endpoint: ${OTLP_LOGGING_ENDPOINT:http://localhost:4318/v1/logs}

logging:
  pattern:
    level: '%5p [${spring.application.name:},%X{traceId:-},%X{spanId:-}]'
  level:
    com.twenty9ine.frauddetection: DEBUG
    software.amazon.awssdk: DEBUG
    org.springframework.kafka: INFO
    org.apache.kafka: INFO
    org.springframework.security: INFO

springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    oauth:
      client-id: fraud-detection-web
      client-secret: fraud-detection-web-secret
      use-pkce-with-authorization-code-grant: true
    oauth2-redirect-url: http://localhost:${server.port}/swagger-ui/oauth2-redirect.html
  oAuthFlow:
    authorizationUrl: http://localhost:8180/realms/fraud-detection/protocol/openid-connect/auth
    tokenUrl: http://localhost:8180/realms/fraud-detection/protocol/openid-connect/token
  # Disable Querydsl support to avoid AOT/Native compilation issues
  default-produces-media-type: application/json
  default-consumes-media-type: application/json
server:
  port: 9001
