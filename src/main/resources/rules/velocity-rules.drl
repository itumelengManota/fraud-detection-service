import com.twenty9ine.frauddetection.domain.valueobject.VelocityMetrics
import com.twenty9ine.frauddetection.domain.valueobject.Transaction
import com.twenty9ine.frauddetection.domain.valueobject.TimeWindow
import com.twenty9ine.frauddetection.domain.valueobject.RuleEvaluationResult
import com.twenty9ine.frauddetection.domain.valueobject.RuleTrigger
import com.twenty9ine.frauddetection.domain.valueobject.RuleViolationSeverity

global RuleEvaluationResult ruleEvaluationResult;

rule "Medium Velocity - 5 Minute Window"
    when
        $velocity : VelocityMetrics(getTransactionCount(TimeWindow.FIVE_MINUTES) > 5,
                                   $count : getTransactionCount(TimeWindow.FIVE_MINUTES))
        $tx : Transaction()
    then
        ruleEvaluationResult.addTrigger(
            new RuleTrigger(
                "VELOCITY_5MIN",
                "Medium Velocity 5min",
                RuleViolationSeverity.MEDIUM,
                "More than 5 transactions in 5 minutes",
                $count
            )
        );
end

rule "High Velocity - 1 Hour Window"
    when
        $velocity : VelocityMetrics(getTransactionCount(TimeWindow.ONE_HOUR) > 20,
                                   $count : getTransactionCount(TimeWindow.ONE_HOUR))
        $tx : Transaction()
    then
        ruleEvaluationResult.addTrigger(
            new RuleTrigger(
                "VELOCITY_1HOUR",
                "High Velocity 1hr",
                RuleViolationSeverity.HIGH,
                "More than 20 transactions in 1 hour",
                $count
            )
        );
end

rule "Excessive Velocity - 24 Hours Window"
    when
        $velocity : VelocityMetrics(getTransactionCount(TimeWindow.TWENTY_FOUR_HOURS) > 80,
                                   $count : getTransactionCount(TimeWindow.TWENTY_FOUR_HOURS))
        $tx : Transaction()
    then
        ruleEvaluationResult.addTrigger(
            new RuleTrigger(
                "VELOCITY_24HOURS",
                "Excessive Velocity 24hrs",
                RuleViolationSeverity.CRITICAL,
                "More than 80 transactions in 24 hours",
                $count
            )
        );
end